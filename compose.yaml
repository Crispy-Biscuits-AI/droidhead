#version: "3.8"
name: droidhead
networks: { droidnet: { driver: bridge } }
services:
  mqtt:
    image: eclipse-mosquitto:2
    container_name: mqtt
    restart: unless-stopped
    networks: [droidnet]
    ports: ["1883:1883"]
    volumes: ["./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro"]
  teacher:
    build: ./teacher
    container_name: teacher
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    environment:
      - STUDENTS_CONFIG=/app/app/config.yaml
      # NVIDIA runtime disabled for macOS compatibility
      # - NVIDIA_VISIBLE_DEVICES=all
      # - NVIDIA_DRIVER_CAPABILITIES=all
    depends_on: [mqtt, llm, asr, tts]
    ports: ["8000:8000"]
    # Device mappings disabled for macOS compatibility
    # devices:
    #   - "${CAMERA_DEVICE:-/dev/video0}:${CAMERA_DEVICE:-/dev/video0}"
    #   - "/dev/snd:/dev/snd"
    #   - "${I2C_BUS:-/dev/i2c-1}:${I2C_BUS:-/dev/i2c-1}"
    # runtime: nvidia
  llm:
    build: ./students/llm
    container_name: student-llm
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    environment:
      - OAI_BASE_URL=http://127.0.0.1:11434/v1
      - OAI_API_KEY=
      - OAI_MODEL=llama3.2:3b
    ports: ["8080:8080"]
  asr:
    build: ./students/asr
    container_name: student-asr
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    environment:
      - ASR_MODEL_SIZE=${ASR_MODEL_SIZE:-base}
      - ASR_DEVICE=${ASR_DEVICE:-cpu}
      - ASR_BEAM_SIZE=${ASR_BEAM_SIZE:-5}
      - ASR_COMPUTE_TYPE=${ASR_COMPUTE_TYPE:-int8}
    ports: ["9000:9000"]
    # runtime: nvidia  # Disabled for macOS compatibility
  tts:
    build: ./students/tts
    container_name: student-tts
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    ports: ["9001:9001"]
  vision:
    image: mpromonet/v4l2rtspserver
    container_name: student-vision
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    # Device mappings disabled for macOS compatibility
    # devices:
    #   - "${CAMERA_DEVICE:-/dev/video0}:${CAMERA_DEVICE:-/dev/video0}"
    command: ["-W","1280","-H","720","-F","15","${CAMERA_DEVICE:-/dev/video0}"]
    ports: ["${RTSP_PORT:-8554}:8554"]
    # runtime: nvidia  # Disabled for macOS compatibility
  periph:
    build: ./students/periph
    container_name: student-periph
    restart: unless-stopped
    networks: [droidnet]
    privileged: true
    env_file: .env
    # Device mappings disabled for macOS compatibility
    # devices:
    #   - "${I2C_BUS:-/dev/i2c-1}:${I2C_BUS:-/dev/i2c-1}"
    #   - "/dev/snd:/dev/snd"
    depends_on: [mqtt]
  webui:
    build: ./webui
    container_name: webui
    restart: unless-stopped
    networks: [droidnet]
    depends_on: [teacher]
    ports: ["3000:3000"]
