version: "3.8"
name: droidhead
networks: { droidnet: { driver: bridge } }
services:
  mqtt:
    image: eclipse-mosquitto:2
    container_name: mqtt
    restart: unless-stopped
    networks: [droidnet]
    ports: ["1883:1883"]
    volumes: ["./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro"]
  teacher:
    build: ./teacher
    container_name: teacher
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    environment:
      - STUDENTS_CONFIG=/app/app/config.yaml
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    depends_on: [mqtt, llm, asr, tts]
    ports: ["8000:8000"]
    devices:
      - "${CAMERA_DEVICE:-/dev/video0}:${CAMERA_DEVICE:-/dev/video0}"
      - "/dev/snd:/dev/snd"
      - "${I2C_BUS:-/dev/i2c-1}:${I2C_BUS:-/dev/i2c-1}"
    runtime: nvidia
  llm:
    build: ./students/llm
    container_name: student-llm
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    environment:
      - OAI_BASE_URL=${OAI_BASE_URL}
      - OAI_API_KEY=${OAI_API_KEY}
      - OAI_MODEL=${OAI_MODEL}
    ports: ["8080:8080"]
  asr:
    build: ./students/asr
    container_name: student-asr
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    environment:
      - ASR_MODEL_SIZE=${ASR_MODEL_SIZE}
      - ASR_DEVICE=${ASR_DEVICE}
      - ASR_BEAM_SIZE=${ASR_BEAM_SIZE}
      - ASR_COMPUTE_TYPE=${ASR_COMPUTE_TYPE}
    ports: ["9000:9000"]
    runtime: nvidia
  tts:
    build: ./students/tts
    container_name: student-tts
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    ports: ["9001:9001"]
  vision:
    image: mpromonet/v4l2rtspserver
    container_name: student-vision
    restart: unless-stopped
    networks: [droidnet]
    env_file: .env
    devices:
      - "${CAMERA_DEVICE:-/dev/video0}:${CAMERA_DEVICE:-/dev/video0}"
    command: ["-W","1280","-H","720","-F","15","${CAMERA_DEVICE:-/dev/video0}"]
    ports: ["${RTSP_PORT:-8554}:8554"]
    runtime: nvidia
  periph:
    build: ./students/periph
    container_name: student-periph
    restart: unless-stopped
    networks: [droidnet]
    privileged: true
    env_file: .env
    devices:
      - "${I2C_BUS:-/dev/i2c-1}:${I2C_BUS:-/dev/i2c-1}"
      - "/dev/snd:/dev/snd"
    depends_on: [mqtt]
  webui:
    build: ./webui
    container_name: webui
    restart: unless-stopped
    networks: [droidnet]
    depends_on: [teacher]
    ports: ["3000:3000"]
